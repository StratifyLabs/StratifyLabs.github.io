
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Deploying CoActionOS</title> 
<meta name="author" content="Stratify Labs, Inc">

<!-- Enable responsive viewport -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<!-- Le styles -->
<link href="/assets/themes/twitter/bootstrap3/css/bootstrap.min.css" rel="stylesheet">
<script src="/assets/themes/twitter/bootstrap3/js/jquery-2.0.3.min.js"></script>
<script src="/assets/themes/twitter/bootstrap3/js/bootstrap.min.js"></script>
<link href="/assets/themes/twitter/bootstrap3/css/font-awesome.min.css" rel="stylesheet">
<link href="/assets/themes/twitter/css/style.css" rel="stylesheet">
<link href="/assets/themes/twitter/css/syntax.css" rel="stylesheet">
<script src="/assets/themes/twitter/js/application.js"></script>

<!-- Le fav and touch icons -->
<!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

<!-- atom & rss feed -->
<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

</head>
<body style="min-height: 200px; padding-top: 50px;">
	<header class="navbar navbar-default navbar-fixed-top bs-docs-nav" role="banner">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="navbar-header">
						<button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".menu-navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="/index.html">
							<img style="height: 22px;" src="/images/StratifyOS-Logo.svg" />
						</a>
					</div>

					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse menu-navbar-collapse" role="navigation">
						<ul class="nav navbar-nav">
							<li><a href="https://github.com/StratifyLabs"><i class="fa fa-code-fork"></i> Code</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</header>

	<a class="anchor" id="top"></a>


	<div class="content" id="content">
		


<div class="container">
	<div class="row" style="margin-top: 20px;">
		<div class="col-md-offset-1 col-md-7">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h1>
						Deploying CoActionOS <small>CoActionOS User Guide</small>
					</h1>
				</div>
				<div class="panel-body">
					<h2 id="from-development-to-production">From Development to Production</h2>

<p>There are two approaches to deploying CoActionOS.</p>

<ol>
  <li>As Is</li>
  <li>Stripped Down</li>
</ol>

<h3 id="deploy-as-is">Deploy As Is</h3>

<p>The first option is to deploy CoActionOS as is without stripping away any part of the OS.  This method has the following advantages.</p>

<ul>
  <li>User Upgradeable Firmware (Applications and Kernel)</li>
  <li>User Installable Apps (3rd Parties can innovate on your product!)</li>
</ul>

<p>The disadvantages:</p>

<ul>
  <li>Larger ROM size</li>
  <li>Security (Users can install code on your device)</li>
</ul>

<h3 id="deploy-a-stripped-down-version">Deploy a Stripped Down Version</h3>

<p>If the cons for the As Is deployment option outweight the pros, you can also deploy a stripped down version of CoActionOS.  You can strip 
away any part of the OS that you don’t need.</p>

<h4 id="exclude-unused-drivers">Exclude Unused Drivers</h4>

<p>The easiest way to shrink the ROM size is to remove device drivers or filesystems that are not needed.  If you look at the files in the <a href="https://github.com/CoActionOS/CoActionOS-HW">board
support packages</a>, you will find a file called devices.c.  This file references the device drivers
and filesystems that will be available to applications.  You just need to comment out anything you are not using to exclude those items
from the binary.  For example, the following lines are commented out to exclude the I2C drivers.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">//DEVICE_PERIPH(&quot;i2c0&quot;, hwpl_i2c, 0, 0666, USER_ROOT, GROUP_ROOT, S_IFCHR),</span>
<span class="c1">//DEVICE_PERIPH(&quot;i2c1&quot;, hwpl_i2c, 1, 0666, USER_ROOT, GROUP_ROOT, S_IFCHR),</span>
<span class="c1">//DEVICE_PERIPH(&quot;i2c2&quot;, hwpl_i2c, 2, 0666, USER_ROOT, GROUP_ROOT, S_IFCHR),</span></code></pre></div>

<p>If you aren’t using the CoActionOS flash filesystem, that can also be excluded.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="kt">sysfs_t</span> <span class="k">const</span> <span class="n">sysfs_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="c1">//the folder for ram/flash applications</span>
	<span class="n">SYSFS_APP</span><span class="p">(</span><span class="s">&quot;/app&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">MEM_DEV</span><span class="p">]),</span> <span class="n">SYSFS_ALL_ACCESS</span><span class="p">),</span>
	<span class="n">SYSFS_DEV</span><span class="p">(</span><span class="s">&quot;/dev&quot;</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">SYSFS_READONLY_ACCESS</span><span class="p">),</span> <span class="c1">//devices</span>
	<span class="c1">//CAFS_LITE(&quot;/home&quot;, &amp;cafs_lite_cfg, SYSFS_ALL_ACCESS), //user files</span>
	<span class="n">SYSFS_ROOT</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">sysfs_list</span><span class="p">,</span> <span class="n">SYSFS_READONLY_ACCESS</span><span class="p">),</span> <span class="c1">//root</span>
	<span class="n">SYSFS_TERMINATOR</span>
<span class="p">};</span></code></pre></div>

<h4 id="exclude-unused-cposix-functions">Exclude Unused C/POSIX functions</h4>

<p>To remove unsed portions of the standard C library or POSIX functions, you need to do a custom build of <a href="https://github.com/CoActionOS/CoActionOS-Public">CoActionOS</a>.  The file you want to modify is src/sys/symbols.c.  This file contains a list of all the functions that, if
not used by the kernel, are still included in the build so that they are available to applications.  It ensures that if an application links
to printf() (see src/crt/crt_symbols.S), then the printf() code will be part of the kernel.  However, if none of your deployed applications use printf(), you don’t need it in the kernel.  To exclude a function, place a zero in the table (don’t delete the line or simply comment it out!).</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">uint32_t</span> <span class="k">const</span> <span class="n">symbols_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="c1">//...</span>
	<span class="mi">0</span><span class="p">,</span> <span class="c1">//(uint32_t)fprintf,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="c1">//(uint32_t)printf,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="c1">//(uint32_t)snprintf,</span>
	<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">vfprintf</span><span class="p">,</span>
	<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">sprintf</span><span class="p">,</span>
	<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">vprintf</span><span class="p">,</span>
	<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">vsnprintf</span><span class="p">,</span>
	<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">vsprintf</span><span class="p">,</span>
	<span class="c1">//...</span>

<span class="p">};</span></code></pre></div>

<h4 id="unify-kernel-and-application">Unify Kernel and Application</h4>

<p>If you still need to make the binary smaller, you can compile the application with the kernel.  In this case, you will want to exclude src/sys/symbols.c from the build entirely.  In the CoActionOS kernel library, the first thread is called intial_thread() and is weakly bound.  You can
add this function to your board support package to override the version in the kernel library.  The default initial thread function is shown below extracted from src/sys/intial_thread.c.  Instead of initializing the link functionality (link_init() and link_update()), you can call the main() function to your application and add the applicatoin source code directly to the board support package in Eclipse.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="o">*</span> <span class="nf">initial_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">arg</span><span class="p">){</span>

	<span class="n">hwpl_core_privcall</span><span class="p">(</span><span class="n">priv_check_reset_source</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="c1">//Initialize the file systems</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">init_fs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">){</span>
		<span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">//Initialize the CoActionOS Link interface</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">link_init</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">){</span>
		<span class="n">hwpl_core_privcall</span><span class="p">(</span><span class="n">gled_priv_error</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">startup_fs</span><span class="p">();</span>

	<span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/rtc&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>

	<span class="n">usleep</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">led_startup</span><span class="p">();</span>
	<span class="n">link_update</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> 	<span class="c1">//Run the link update thread--never returns</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<h4 id="remove-the-bootloader">Remove the Bootloader</h4>

<p>On the CoAction-Hero, the bootloader is installed at address 0x0 while the kernel is installed at 0x40000 (at the 256K boundary of the 512K device).  If you don’t need the bootloader, you can tell Eclipse to compile the kernel to execute at address 0x0 instead of 0x40000 (see Eclipse Project Properties-&gt;C/C++ Build-&gt;Build Variables-&gt;START_ADDR) and then use a JTAG or UART install tool to load the kernel.</p>

<h2 id="take-away">Take Away</h2>

<p>The easiest way to shrink the size of CoActionOS is to exclude used drivers.  You can do this and still allow users to install custom apps and
upgrade the kernel.  You can further reduce the kernel size by limited the C/POSIX functions that are available to applications by modifying the symbol table in the CoActionOS kernel library.  Finally, you can disregard the kernel symbol table and just compile the application and kernel in a unified binary.</p>


				</div>
			</div>

			
			<ul class="nav nav-pills">
				
				


  
     
    	<li><a href="/tags.html#coaction-ref">coaction <span class="badge">22</span></a></li>
     
    	<li><a href="/tags.html#user-guide-ref">user-guide <span class="badge">7</span></a></li>
    
  



			</ul>
			
			<div class="pagination">
				<center>
					 
						<a href="/embedded%20design%20tips/2014/01/07/Tips-Integrating-Doxygen-and-Bootstrap" type="button" class="btn btn-primary"
							data-toggle="tooltip" data-placement="left" title="" data-original-title="Previous Post"
							>
							<i class="fa fa-arrow-left"></i>
						</a> 
					 
					<a href="/archive.html" type="button" class="btn btn-primary"
						data-toggle="tooltip" data-placement="top" title="" data-original-title="Archives"
						>
						<i class="fa fa-archive"></i>
					</a> 
					<a href="/categories.html" type="button" class="btn btn-primary"
						data-toggle="tooltip" data-placement="top" title="" data-original-title="Categories"
					>
						<i class="fa fa-folder-open"></i>
					</a> 
					 
						<a href="/embedded%20design%20tips/2014/05/03/Applications-without-MMU" type="button" class="btn btn-primary"
							data-toggle="tooltip" data-placement="right" title="" data-original-title="Next Post"
							>
							<i class="fa fa-arrow-right"></i>
						</a>
					
				</center>
			</div>
				
		</div>
		<div class="col-md-3">
		

			<h3>User Guides</h3>
			<ul class="nav nav-pills nav-stacked">
				
				
				


  
    
      
      	
      	<li class='active tagged coaction user-guide'><a href="/user%20guides/2014/04/15/CoActionOS-User-Guide-Deploying-CoActionOS" class="active">Deploying CoActionOS</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/20/CoActionOS-User-Guide-Installing-Windows-Device-Drivers">Installing Windows Device Drivers</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/18/CoActionOS-User-Guide-Device-Driver-Development">Device Driver Development</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/17/CoActionOS-User-Guide-Designing-Applications-using-State-Machines">Designing Applications using State Machines</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/16/CoActionOS-User-Guide-CoActionOS-and-Eclipse">Developing on CoActionOS using Eclipse</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/15/CoActionOS-User-Guide-Building-and-Installing-CoActionOS">Building and Installing CoActionOS</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/14/CoActionOS-User-Guide-Getting-Started">Getting Started</a></li>
      	
      
    
  



			</ul>
			
			
			
			  
		</div>
	</div>

</div>



	</div>

	<footer style="background: #344555; color: #fff;">
		<div class="container">
			<div class="row" style="margin-top: 20px; margin-bottom: 20px; ">
				<div class="col-md-12">
					<p>&copy; 2016 Stratify Labs, Inc</p>
				</div>
			</div>
		</div>
	</footer>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21543723-3', 'coactionos.com');
  ga('send', 'pageview');

</script>
 </body>
</html>

