
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Designing Applications using State Machines</title> 
<meta name="author" content="Stratify Labs, Inc">

<!-- Enable responsive viewport -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<!-- Le styles -->
<link href="/assets/themes/twitter/bootstrap3/css/bootstrap.min.css" rel="stylesheet">
<script src="/assets/themes/twitter/bootstrap3/js/jquery-2.0.3.min.js"></script>
<script src="/assets/themes/twitter/bootstrap3/js/bootstrap.min.js"></script>
<link href="/assets/themes/twitter/bootstrap3/css/font-awesome.min.css" rel="stylesheet">
<link href="/assets/themes/twitter/css/style.css" rel="stylesheet">
<link href="/assets/themes/twitter/css/syntax.css" rel="stylesheet">
<script src="/assets/themes/twitter/js/application.js"></script>

<!-- Le fav and touch icons -->
<!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

<!-- atom & rss feed -->
<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

</head>
<body style="min-height: 200px; padding-top: 50px;">
	<header class="navbar navbar-default navbar-fixed-top bs-docs-nav" role="banner">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="navbar-header">
						<button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".menu-navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="/index.html">
							<img style="height: 22px;" src="/images/StratifyOS-Logo.svg" />
						</a>
					</div>

					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse menu-navbar-collapse" role="navigation">
						<ul class="nav navbar-nav">
							<li><a href="https://github.com/StratifyLabs"><i class="fa fa-code-fork"></i> Code</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</header>

	<a class="anchor" id="top"></a>


	<div class="content" id="content">
		


<div class="container">
	<div class="row" style="margin-top: 20px;">
		<div class="col-md-offset-1 col-md-7">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h1>
						Designing Applications using State Machines <small>CoActionOS User Guide</small>
					</h1>
				</div>
				<div class="panel-body">
					<h2 id="introduction">Introduction</h2>

<p>A state machine is a model that helps when designing computer programs.  The state 
machine is represented by a state diagram that shows 1) what states the 
program can have, 2) how the program transitions between states, and 3) what 
actions the programs takes while entering, exiting, or executing a state.  A 
simple example of a state machine is a turnstile.  The following 
diagram (from wikipedia) shows how the state machine works.</p>

<p><img class="post_image" src="/images/turnstile.png" /></p>

<p>The diagram shows at startup, the turnstile is locked.  When a coin is inserted, the 
turnstile transitions to unlocked until someone walks through.</p>

<h2 id="a-coactionos-example">A CoActionOS Example</h2>

<h3 id="smach-and-state">SMach and State</h3>

<p>CoActionOS Applib provides a C++ class for defining and executing state machines.  For 
this example, we will use an alarm application.  The program will start in the “home” 
state.  When the user pushes start, the program will enter the “timer” state.  From 
the “timer” state the user can push the reset button to return “home” or after 10 
seconds, the state machine will transition to the “alarm” state.</p>

<p><img class="post_image" src="/images/states.png" /></p>

<p>To implement the state machine, we use two Applib classes <a href="/coactionos-applib/html/class_s_mach.html">SMach</a> as 
the top level state machine and <a href="/coactionos-applib/html/class_state.html">State</a> for 
each individual state.  Each state is implemented as it’s own class which 
inherits <a href="/coactionos-applib/html/class_state.html">State</a> and re-implements:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">name</span><span class="p">();</span>  <span class="c1">//unique state name</span>
<span class="kt">bool</span> <span class="nf">entry_action</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span> <span class="c1">//action to execute when entering the state</span>
<span class="kt">bool</span> <span class="nf">action</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span> <span class="c1">//action to execute while state is active</span>
<span class="n">State</span> <span class="o">*</span> <span class="nf">exit_condition</span><span class="p">(</span><span class="n">State</span> <span class="o">*</span> <span class="n">slist</span><span class="p">[]);</span> <span class="c1">//Executing to see if state should transition</span></code></pre></div>

<p>The methods above fit in to the state diagram above as noted below.</p>

<p><img class="post_image" src="/images/states-info.png" /></p>

<h3 id="home-state">Home State</h3>

<p>This means the “home” state class looks like this:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;applib/State.hpp&gt;</span>
<span class="cp">#include &lt;applib/Pin.hpp&gt;</span>

<span class="k">class</span> <span class="nc">HomeState</span> <span class="o">:</span> <span class="k">public</span> <span class="n">State</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">HomeState</span><span class="p">()</span> <span class="o">:</span> <span class="n">State</span><span class="p">()</span> <span class="p">{};</span>

	<span class="c1">//The name of the state</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">name</span><span class="p">(){</span> <span class="k">return</span> <span class="s">&quot;home&quot;</span><span class="p">;</span> <span class="p">}</span>

	<span class="c1">//The state machine executes this function when the state is entered</span>
	<span class="kt">bool</span> <span class="nf">entry_action</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>

	<span class="c1">//The state executes this function while the state is active</span>
	<span class="kt">bool</span> <span class="nf">action</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>

	<span class="c1">//The state executes this function while the state is active</span>
	<span class="c1">//If this function returns a State other than 0 -- the state machine will transition to the new state</span>
	<span class="n">State</span> <span class="o">*</span> <span class="nf">exit_condition</span><span class="p">(</span><span class="n">State</span> <span class="o">*</span> <span class="n">slist</span><span class="p">[]){</span>
		<span class="n">State</span> <span class="o">*</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Pin</span> <span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//assume state button is on P1.0</span>
		<span class="n">start</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Pin</span><span class="o">::</span><span class="n">INPUT</span> <span class="o">|</span> <span class="n">Pin</span><span class="o">::</span><span class="n">PULLDOWN</span><span class="p">);</span> <span class="c1">//this only NEEDS to be called once at system startup</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">start</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="nb">true</span> <span class="p">){</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">slist</span><span class="p">,</span> <span class="s">&quot;timer&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span></code></pre></div>

<p>The “timer” and “alarm” states are similarly defined.  The “timer” state’s name() method must return “timer” in order to the home state to find the state in the list.  Next we will look at how the state machine is executed using SMach.</p>

<h3 id="state-machine-execution">State Machine Execution</h3>

<p>The state machine is a special type of state that contains a list of states that define the machine.  It is declared quite similarly to a State.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;applib/SMach.hpp&gt;</span>
<span class="k">class</span> <span class="nc">Machine</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SMach</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">Machine</span><span class="p">();</span>
	<span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">bool</span> <span class="nf">action</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="p">};</span></code></pre></div>

<p>The run() method will be used to execute the state machine.  The action() method is optional.  It allows the state machine to execute some action whenever any state within the machine is active.  For example, if you want to delay 10ms between executing state actions for all states, it can be done using the action() method as in the example below.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;applib/Timer.hpp&gt;</span>
<span class="cp">#include &quot;Machine.hpp&quot;</span>

<span class="cp">#include &quot;HomeState.hpp&quot;</span>
<span class="cp">#include &quot;AlarmState.hpp&quot;</span>
<span class="cp">#include &quot;TimerState.hpp&quot;</span>

<span class="k">static</span> <span class="n">HomeState</span> <span class="n">home</span><span class="p">;</span>
<span class="k">static</span> <span class="n">AlarmState</span> <span class="n">alarm</span><span class="p">;</span>
<span class="k">static</span> <span class="n">TimerState</span> <span class="n">timer</span><span class="p">;</span>

<span class="c1">//This is the state list -- it defines the states within the state machine</span>
<span class="n">State</span> <span class="o">*</span> <span class="n">states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="o">&amp;</span><span class="n">home</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">alarm</span><span class="p">,</span>
		<span class="mi">0</span>
<span class="p">};</span>

<span class="n">Machine</span><span class="o">::</span><span class="n">Machine</span><span class="p">()</span> <span class="o">:</span> <span class="n">SMach</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">){}</span>

<span class="kt">void</span> <span class="n">Machine</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
	<span class="n">SMach</span><span class="o">::</span><span class="n">exec</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Machine</span><span class="o">::</span><span class="n">action</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
	<span class="c1">//This is executed when any state within the state machine is active</span>
	<span class="n">Timer</span><span class="o">::</span><span class="n">wait_msec</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="c1">//Now call the parent action to execute the action within the active state</span>
	<span class="k">return</span> <span class="n">SMach</span><span class="o">::</span><span class="n">action</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<p>As you can see in the action() method, we delay for 10ms.  This will be called in the “home”, “timer”, and “alarm” states.  Call it a “global” action.  If a global state machine action is not used, you don’t need to re-implement the action() method at all.</p>

<p>Since this <a href="/coactionos-applib/html/class_s_mach.html">SMach</a> is a top 
level machine, we don’t implement the exit_condition() method.  However, 
an <a href="/coactionos-applib/html/class_s_mach.html">SMach</a> is just a special 
type of <a href="/coactionos-applib/html/class_state.html">State</a> and can be part 
of a higher level SMach’s state list.</p>

<h2 id="conclusion">Conclusion</h2>

<p>State machines are a great way of designing complex firmware programs.  Using the Applib 
<a href="/coactionos-applib/html/class_s_mach.html">SMach</a> and <a href="/coactionos-applib/html/class_state.html">State</a> classes 
makes doing so quick and easy.</p>

				</div>
			</div>

			
			<ul class="nav nav-pills">
				
				


  
     
    	<li><a href="/tags.html#coaction-ref">coaction <span class="badge">22</span></a></li>
     
    	<li><a href="/tags.html#user-guide-ref">user-guide <span class="badge">7</span></a></li>
    
  



			</ul>
			
			<div class="pagination">
				<center>
					 
						<a href="/user%20guides/2013/12/16/CoActionOS-User-Guide-CoActionOS-and-Eclipse" type="button" class="btn btn-primary"
							data-toggle="tooltip" data-placement="left" title="" data-original-title="Previous Post"
							>
							<i class="fa fa-arrow-left"></i>
						</a> 
					 
					<a href="/archive.html" type="button" class="btn btn-primary"
						data-toggle="tooltip" data-placement="top" title="" data-original-title="Archives"
						>
						<i class="fa fa-archive"></i>
					</a> 
					<a href="/categories.html" type="button" class="btn btn-primary"
						data-toggle="tooltip" data-placement="top" title="" data-original-title="Categories"
					>
						<i class="fa fa-folder-open"></i>
					</a> 
					 
						<a href="/user%20guides/2013/12/18/CoActionOS-User-Guide-Device-Driver-Development" type="button" class="btn btn-primary"
							data-toggle="tooltip" data-placement="right" title="" data-original-title="Next Post"
							>
							<i class="fa fa-arrow-right"></i>
						</a>
					
				</center>
			</div>
				
		</div>
		<div class="col-md-3">
		

			<h3>User Guides</h3>
			<ul class="nav nav-pills nav-stacked">
				
				
				


  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2014/04/15/CoActionOS-User-Guide-Deploying-CoActionOS">Deploying CoActionOS</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/20/CoActionOS-User-Guide-Installing-Windows-Device-Drivers">Installing Windows Device Drivers</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/18/CoActionOS-User-Guide-Device-Driver-Development">Device Driver Development</a></li>
      	
      
    
  
    
      
      	
      	<li class='active tagged coaction user-guide'><a href="/user%20guides/2013/12/17/CoActionOS-User-Guide-Designing-Applications-using-State-Machines" class="active">Designing Applications using State Machines</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/16/CoActionOS-User-Guide-CoActionOS-and-Eclipse">Developing on CoActionOS using Eclipse</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/15/CoActionOS-User-Guide-Building-and-Installing-CoActionOS">Building and Installing CoActionOS</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged coaction user-guide'><a href="/user%20guides/2013/12/14/CoActionOS-User-Guide-Getting-Started">Getting Started</a></li>
      	
      
    
  



			</ul>
			
			
			
			  
		</div>
	</div>

</div>



	</div>

	<footer style="background: #344555; color: #fff;">
		<div class="container">
			<div class="row" style="margin-top: 20px; margin-bottom: 20px; ">
				<div class="col-md-12">
					<p>&copy; 2016 Stratify Labs, Inc</p>
				</div>
			</div>
		</div>
	</footer>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21543723-3', 'coactionos.com');
  ga('send', 'pageview');

</script>
 </body>
</html>

