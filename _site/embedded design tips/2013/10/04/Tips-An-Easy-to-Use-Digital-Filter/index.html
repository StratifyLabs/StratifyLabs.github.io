
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>An Easy-to-Use Digital Filter</title> 
<meta name="author" content="Stratify Labs, Inc">

<!-- Enable responsive viewport -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<!-- Le styles -->
<link href="/assets/themes/twitter/bootstrap3/css/bootstrap.min.css" rel="stylesheet">
<script src="/assets/themes/twitter/bootstrap3/js/jquery-2.0.3.min.js"></script>
<script src="/assets/themes/twitter/bootstrap3/js/bootstrap.min.js"></script>
<link href="/assets/themes/twitter/bootstrap3/css/font-awesome.min.css" rel="stylesheet">
<link href="/assets/themes/twitter/css/style.css" rel="stylesheet">
<link href="/assets/themes/twitter/css/syntax.css" rel="stylesheet">
<script src="/assets/themes/twitter/js/application.js"></script>

<!-- Le fav and touch icons -->
<!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

<!-- atom & rss feed -->
<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

</head>
<body style="min-height: 200px; padding-top: 50px;">
	<header class="navbar navbar-default navbar-fixed-top bs-docs-nav" role="banner">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="navbar-header">
						<button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".menu-navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="/index.html">
							<img style="height: 22px;" src="/images/StratifyOS-Logo.svg" />
						</a>
					</div>

					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse menu-navbar-collapse" role="navigation">
						<ul class="nav navbar-nav">
							<li><a href="https://github.com/StratifyLabs"><i class="fa fa-code-fork"></i> Code</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</header>

	<a class="anchor" id="top"></a>


	<div class="content" id="content">
		


<div class="container">
	<div class="row" style="margin-top: 20px;">
		<div class="col-md-offset-1 col-md-7">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h1>
						An Easy-to-Use Digital Filter <small>Embedded Design</small>
					</h1>
				</div>
				<div class="panel-body">
					<p><img class="post_image_tall" src="/images/316px-Fourier_Series.png" />
The exponential moving average (EMA) is a type of infinite impulse response (IIR) filter 
that can be used in many embedded DSP applications.  It requires only a small amount 
of RAM and computing power.</p>

<h2 id="what-is-a-filter">What is a Filter?</h2>

<p>Filters come in both analog and digital forms and exist to remove specific frequencies 
from a signal.  A common analog filter is the low pass RC filter shown below.</p>

<p><img class="post_image_tall" src="/images/lpf-1st-order.png" /></p>

<p>Analog filters are characterized by their frequency response; that is how much the 
frequencies are attenuated (magnitude response) and shifted (phase response).  The 
frequency response can be analyzed using a Laplace transform which defines a transfer 
function in the S-domain.  For the above circuit, the transfer function is given by:</p>

<p><img class="post_equation" src="/images/filter-formula1.svg" /></p>

<p>For R equals one kilo-ohm and C equals one microfarad, the magnitude response is 
shown below.</p>

<p><img class="post_image" src="/images/lpf-mag.png" /></p>

<p>Note that the x-axis is logarithmic (every tick mark is 10 times greater than the last one).  The y-axis is in decibels (which is a logarithmic function of the output).  The “cutoff frequency” for this filter is 1000 rad/s or 160 Hz.  This is the point where less than half the power at a given frequency is transferred from the input to the output of the filter.</p>

<p>Analog filters must be used in embedded designs when sampling a signal using an 
analog to digital converter (ADC).  The ADC only captures frequencies that are 
up to half the sampling frequency.  For example, if the ADC acquires 320 samples 
per second, the filter above (with a cutoff frequency of 160Hz) is placed between 
the signal and the ADC input to prevent aliasing (which is a phenomena where higher 
frequencies show up in the sampled signal as lower frequencies).</p>

<h3 id="digital-filters">Digital Filters</h3>

<p>Digital filters attenuate frequencies in software rather than using analog 
components.  Their implementation includes sampling the analog signals with 
an ADC then applying a software algorithm.  Two common design approaches to 
digital filtering are FIR filters and IIR filters.</p>

<h3 id="fir-filters">FIR Filters</h3>

<p>Finite Impulse Response (FIR) filters use a finite number of samples to generate 
the output.  A simple moving average is an example of a low pass FIR filter.  Higher 
frequencies are attenuated because the averaging “smooths” out the signal.  The 
filter is finite because the output of the filter is determined by a finite number 
of input samples.  As an example, a 12 point moving average filter adds up the 12 most 
recent samples then divides by 12.  The output of IIR filters is determined 
by (up to) an infinite number of input samples.</p>

<h3 id="iir-filters">IIR Filters</h3>

<p>Infinite Impulse Response (IIR) filters are a type of digital filter where the 
output is inifinetely–in theory anyway–influenced by an input.  The exponential 
moving average is an example of a low pass IIR filter.</p>

<h2 id="exponential-moving-average-filter">Exponential Moving Average Filter</h2>

<p>An exponential moving average (EMA) applies exponential weights to each sample 
in order to compute an average.  Though this seems complicated, the 
equation–known in digital filtering parlance as the difference equation–to 
compute the output is simple.  In the equation below, y is the output; x is 
the input; and alpha is a constant that sets the cutoff frequency.</p>

<p><img class="post_equation" src="/images/filter-formula2.svg" /></p>

<p>To analyze how this filter impacts the frequency of the output, the Z-domain transfer 
function is used. </p>

<p><img class="post_equation" src="/images/filter-formula3.svg" /></p>

<p>The magnitude response is shown below for alpha equal 0.5.</p>

<p><img class="post_image" src="/images/dig-mag.png" /></p>

<p>The y-axis is, again, shown in decibels.  The x-axis is logarithmic from 0.001 to 
pi.  The real-world frequency maps to the x-axis with zero being the DC voltage 
and pi being equal to half the sampling frequency.  Any frequencies that are 
greater than half the sampling frequency will be “aliased”. As mentioned, an 
analog filter can ensure practically all frequencies in the digital signal are 
below half the sampling frequency.</p>

<p>The EMA filter is beneficial in embedded designs for two reasons.  First, it is 
easy to adjust the cutoff frequency.  Decreasing the value of alpha will lower 
the cutoff frequency of the filter as illustrated by comparing the above 
alpha = 0.5 plot to the below plot where alpha = 0.1.</p>

<p><img class="post_image" src="/images/dig-mag2.png" /></p>

<p>Second, the EMA is easy to code and requires only a small amount of computing power 
and memory.  The code implementation of the filter uses the difference equation.  There 
are two multiply operations and one addition operation for each output–this ignores 
the operations required for rounding fixed point math.  Only the most recent sample 
must be stored in RAM.  This is substantially less than using a simple moving average 
filter with N points which requires N multiply and addition operations as well as N 
samples to be stored in RAM.  The following code implements the EMA filter using 32-bit 
fixed point math.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#define DSP_EMA_I32_ALPHA(x) ( (uint16_t)(x * 65535) )</span>
 
<span class="kt">int32_t</span> <span class="nf">dsp_ema_i32</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">average</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">alpha</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">alpha</span> <span class="o">==</span> <span class="mi">65535</span> <span class="p">)</span> <span class="k">return</span> <span class="n">in</span><span class="p">;</span>
  <span class="kt">int64_t</span> <span class="n">tmp0</span><span class="p">;</span>
  <span class="n">tmp0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">in</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">average</span> <span class="o">*</span> <span class="p">(</span><span class="mi">65536</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)((</span><span class="n">tmp0</span> <span class="o">+</span> <span class="mi">32768</span><span class="p">)</span> <span class="o">/</span> <span class="mi">65536</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>The code below is an example of how to use the above function.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int32_t</span> <span class="nf">my_avg_func</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
     <span class="k">static</span> <span class="kt">int32_t</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="kt">int32_t</span> <span class="n">adc_value</span><span class="p">;</span>    
     <span class="n">adc_value</span> <span class="o">=</span> <span class="n">read_the_adc_value</span><span class="p">();</span>
     <span class="n">average</span> <span class="o">=</span> <span class="n">dsp_ema_i32</span><span class="p">(</span><span class="n">adc_value</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="n">DSP_EMA_I32_ALPHA</span><span class="p">(</span><span class="mf">0.1</span><span class="p">));</span>
     <span class="k">return</span> <span class="n">average</span><span class="p">;</span></code></pre></div>

<h2 id="conclusion">Conclusion</h2>

<p>Filters, both analog and digital, are an essential part of embedded designs.  They 
allow developers to get rid of unwanted frequencies when analyzing sensor input.  For 
digital filters to be useful, analog filters must remove all frequencies above half 
the sampling frequency.  Digital IIR filters can be powerful tools in embedded design 
where resources are limited.  The exponential moving average (EMA) is an example of 
such a filter that works well in embedded designs because of the low memory and 
computing power requirements.</p>


				</div>
			</div>

			
			<ul class="nav nav-pills">
				
				


  
     
    	<li><a href="/tags.html#embedded-ref">embedded <span class="badge">36</span></a></li>
     
    	<li><a href="/tags.html#filter-ref">filter <span class="badge">3</span></a></li>
     
    	<li><a href="/tags.html#iir-ref">iir <span class="badge">1</span></a></li>
     
    	<li><a href="/tags.html#programming-ref">programming <span class="badge">9</span></a></li>
     
    	<li><a href="/tags.html#popular-ref">popular <span class="badge">11</span></a></li>
    
  



			</ul>
			
			<div class="pagination">
				<center>
					 
						<a href="/embedded%20design%20tips/2013/10/03/Tips-ADC-Thermistor-Circuit-and-Lookup-Table" type="button" class="btn btn-primary"
							data-toggle="tooltip" data-placement="left" title="" data-original-title="Previous Post"
							>
							<i class="fa fa-arrow-left"></i>
						</a> 
					 
					<a href="/archive.html" type="button" class="btn btn-primary"
						data-toggle="tooltip" data-placement="top" title="" data-original-title="Archives"
						>
						<i class="fa fa-archive"></i>
					</a> 
					<a href="/categories.html" type="button" class="btn btn-primary"
						data-toggle="tooltip" data-placement="top" title="" data-original-title="Categories"
					>
						<i class="fa fa-folder-open"></i>
					</a> 
					 
						<a href="/embedded%20design%20tips/2013/10/05/Tips-Building-and-Installing-a-Cortex-M3-Compiler-in-Windows" type="button" class="btn btn-primary"
							data-toggle="tooltip" data-placement="right" title="" data-original-title="Next Post"
							>
							<i class="fa fa-arrow-right"></i>
						</a>
					
				</center>
			</div>
				
		</div>
		<div class="col-md-3">
		

			<h3>Embedded Design Tips</h3>
			<ul class="nav nav-pills nav-stacked">
				
				
				


  
    
      
      	
      	<li class='tagged embedded gcc compiler macosx'><a href="/embedded%20design%20tips/2014/10/05/Tips-Building-and-Installing-a-Cortex-M4-Compiler-on-Mac-OS-X">Building and Installing a Cortex-M4 Compiler on Mac OS X</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded microcontroller arm cortex-m3 coaction'><a href="/embedded%20design%20tips/2014/05/03/Applications-without-MMU">Applications without an MMU</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged doxygen javascript bootstrap'><a href="/embedded%20design%20tips/2014/01/07/Tips-Integrating-Doxygen-and-Bootstrap">Integrating Doxygen and Bootstrap</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded circuit'><a href="/embedded%20design%20tips/2013/10/27/Tips-Using-Op-Amps-in-Embedded-Design">Using Op Amps in Embedded Design</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded control gpio'><a href="/embedded%20design%20tips/2013/10/26/Tips-Controlling-a-Solenoid">Controlling a Solenoid</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded gpio circuit microcontroller popular'><a href="/embedded%20design%20tips/2013/10/25/Tips-Using-Pull-Up-and-Pull-Down-Resistors">Using Pull-Up and Pull-Down Resistors</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded circuit led control'><a href="/embedded%20design%20tips/2013/10/24/Tips-Using-LEDs-in-Embedded-Designs">Using LEDs in Embedded Designs</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded c doxygen programming'><a href="/embedded%20design%20tips/2013/10/23/Tips-Using-Doxygen-with-C">Using Doxygen with C</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded usb programming microcontroller serial'><a href="/embedded%20design%20tips/2013/10/22/Tips-USB-Virtual-Serial-Port-Firmware">USB Virtual Serial Port Firmware</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded microcontroller gpio programming'><a href="/embedded%20design%20tips/2013/10/21/Tips-Understanding-Microcontroller-Pin-Input-Output-Modes">Understanding Microcontroller Pin Input/Output Modes</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded circuit sensor filter adc programming'><a href="/embedded%20design%20tips/2013/10/19/Tips-Sensing-the-Source-Current-in-an-Embedded-Application">Sensing the Source Current in an Embedded Application</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded c programming popular'><a href="/embedded%20design%20tips/2013/10/18/Tips-RAM-Flash-Usage-in-Embedded-C-Programs">RAM/Flash Usage in Embedded C Programs</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded control pwm pid motor programming circuit popular'><a href="/embedded%20design%20tips/2013/10/15/Tips-Motor-Control-using-PWM-and-PID">Motor Control using PWM and PID</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded microcontroller circuit'><a href="/embedded%20design%20tips/2013/10/14/Tips-How-Microcontrollers-Work">How Microcontrollers Work</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded cortex-m3 fft filter popular'><a href="/embedded%20design%20tips/2013/10/13/Tips-FFT-on-the-ARM-Cortex-M3">FFT on the ARM Cortex M3</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded cortex-m3'><a href="/embedded%20design%20tips/2013/10/12/Tips-Effective-Use-of-ARM-Cortex-M3-SVCall">Effective Use of ARM Cortex-M3 SVCall</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded macosx qt'><a href="/embedded%20design%20tips/2013/10/11/Tips-Deploying-Qt-Applications-on-Mac-OSX">Deploying Qt Applications on Mac OSX</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded circuit power popular'><a href="/embedded%20design%20tips/2013/10/10/Tips-Decoupling-Capacitors">Decoupling Capacitors (and Other Power Rules of Thumb)</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded cortex-m3 threads popular'><a href="/embedded%20design%20tips/2013/10/09/Tips-Context-Switching-on-the-Cortex-M3">Context Switching on the Cortex-M3</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded compiler gcc'><a href="/embedded%20design%20tips/2013/10/08/Tips-Building-and-Installing-Autotools">Building and Installing Autotools</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded gcc compiler linux'><a href="/embedded%20design%20tips/2013/10/07/Tips-Building-and-Installing-a-Cortex-M3-Compiler-on-Ubuntu">Building and Installing a Cortex-M3 Compiler on Ubuntu</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded gcc compiler macosx'><a href="/embedded%20design%20tips/2013/10/06/Tips-Building-and-Installing-a-Cortex-M3-Compiler-on-Mac-OS-X">Building and Installing a Cortex-M3 Compiler on Mac OS X</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded gcc compiler windows'><a href="/embedded%20design%20tips/2013/10/05/Tips-Building-and-Installing-a-Cortex-M3-Compiler-in-Windows">Building and Installing a Cortex-M3 Compiler in Windows</a></li>
      	
      
    
  
    
      
      	
      	<li class='active tagged embedded filter iir programming popular'><a href="/embedded%20design%20tips/2013/10/04/Tips-An-Easy-to-Use-Digital-Filter" class="active">An Easy-to-Use Digital Filter</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded adc lookup-table c programming'><a href="/embedded%20design%20tips/2013/10/03/Tips-ADC-Thermistor-Circuit-and-Lookup-Table">ADC Thermistor Circuit and Lookup Table</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded fifo uart serial microcontroller programming popular'><a href="/embedded%20design%20tips/2013/10/02/Tips-A-FIFO-Buffer-Implementation">A FIFO Buffer Implementation</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded microcontroller popular'><a href="/embedded%20design%20tips/2013/10/01/Tips-8-vs-16-vs-32-Bit-Microcontrollers">8 vs 16 vs 32 Bit Microcontrollers--A Case Study</a></li>
      	
      
    
  



			</ul>
			
			
				<h3>Embedded C Tutorial</h3>
				<ul class="nav nav-pills nav-stacked">
					  
					


  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/11/Embedded-C-Tutorial-Order-of-Operations">Order of Operations Reference</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/10/Embedded-C-Tutorial-Keyword-Reference">Keywords Reference</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/09/Embedded-C-Tutorial-Compound-Data-Types">Compound Data Types</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/08/Embedded-C-Tutorial-Preprocessor">Preprocessor Directives</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/07/Embedded-C-Tutorial-Pointers-and-Arrays">Pointers and Arrays</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/05/Embedded-C-Tutorial-Flow-Control">Flow Control</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/04/Embedded-C-Tutorial-Operators">Operators</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/03/Embedded-C-Tutorial-Raw-Types">Raw Types</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial'><a href="/embedded%20c%20tutorial/2013/12/02/Embedded-C-Tutorial-Functions">Functions</a></li>
      	
      
    
  
    
      
      	
      	<li class='tagged embedded tutorial popular'><a href="/embedded%20c%20tutorial/2013/12/01/Embedded-C-Tutorial-Hello-World">Hello World</a></li>
      	
      
    
  



				</ul>
			
			
			
			  
		</div>
	</div>

</div>



	</div>

	<footer style="background: #344555; color: #fff;">
		<div class="container">
			<div class="row" style="margin-top: 20px; margin-bottom: 20px; ">
				<div class="col-md-12">
					<p>&copy; 2016 Stratify Labs, Inc</p>
				</div>
			</div>
		</div>
	</footer>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21543723-3', 'coactionos.com');
  ga('send', 'pageview');

</script>
 </body>
</html>

